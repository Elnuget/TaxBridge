<c-container fluid>
  <!-- Header -->
  <c-row class="mb-4">
    <c-col>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="cil-graph me-2"></i>
            Grafo de Credenciales SRI
          </h2>
          <p class="text-muted mb-0">Visualización jerárquica del sistema de acceso a credenciales</p>
        </div>
        <div class="d-flex gap-2">
          <button cButton color="secondary" (click)="refreshGraph()">
            <i class="cil-reload me-1"></i> Actualizar
          </button>
          <button cButton color="primary" [routerLink]="['/sri-credentials']">
            <i class="cil-list me-1"></i> Ver Lista
          </button>
        </div>
      </div>
    </c-col>
  </c-row>

  <!-- Leyenda del Grafo -->
  <c-row class="mb-4">
    <c-col>
      <c-card>
        <c-card-body class="py-2">
          <div class="d-flex justify-content-center align-items-center flex-wrap gap-4">
            <div class="legend-item">
              <span class="node-indicator node-admin"></span>
              <span>Admin</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-contador"></span>
              <span>Contador</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-customer"></span>
              <span>Cliente</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-credential"></span>
              <span>Credencial SRI</span>
            </div>
            <div class="legend-item">
              <span class="edge-indicator solid"></span>
              <span>Relación directa</span>
            </div>
            <div class="legend-item">
              <span class="edge-indicator dashed"></span>
              <span>Delegación temporal</span>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Estadísticas del Grafo -->
  <c-row class="mb-4">
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-primary">{{ stats.totalNodes }}</div>
          <small class="text-muted">Nodos</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-secondary">{{ stats.totalEdges }}</div>
          <small class="text-muted">Conexiones</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-info">{{ stats.contadores }}</div>
          <small class="text-muted">Contadores</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-success">{{ stats.clientes }}</div>
          <small class="text-muted">Clientes</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-warning">{{ stats.credenciales }}</div>
          <small class="text-muted">Credenciales</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-danger">{{ stats.delegaciones }}</div>
          <small class="text-muted">Delegaciones</small>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <c-spinner color="primary" size="lg"></c-spinner>
    <p class="mt-3 text-muted">Cargando estructura del grafo...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-danger text-center">
    <i class="cil-warning me-2"></i>{{ error }}
  </div>

  <!-- Visualización del Grafo -->
  <c-row *ngIf="!loading && !error && graph">
    <c-col>
      <c-card>
        <c-card-header>
          <strong>Estructura Jerárquica</strong>
          <span class="text-muted ms-2">
            (Admin → Contadores → Clientes → Credenciales)
          </span>
        </c-card-header>
        <c-card-body>
          <div class="graph-container">
            <!-- Iterar por niveles -->
            <div *ngFor="let level of getLevels()" class="graph-level">
              <div class="level-header">
                <c-badge color="dark">{{ getLevelTitle(level) }}</c-badge>
              </div>
              <div class="level-nodes">
                <div 
                  *ngFor="let node of nodesByLevel[level]" 
                  class="graph-node" 
                  [ngClass]="getNodeClass(node.type)">
                  <div class="node-icon">
                    <i [class]="getNodeIcon(node.type)"></i>
                  </div>
                  <div class="node-content">
                    <div class="node-label">{{ node.label }}</div>
                    <div class="node-details" *ngIf="node.email">
                      <small>{{ node.email }}</small>
                    </div>
                    <div class="node-details" *ngIf="node.customerNumber">
                      <small>{{ node.customerNumber }}</small>
                    </div>
                    <div class="node-details" *ngIf="node.credentialId">
                      <small class="font-monospace">{{ node.credentialId }}</small>
                    </div>
                    <div class="node-status" *ngIf="node.status">
                      <c-badge 
                        [color]="node.status === 'active' ? 'success' : 'secondary'" 
                        size="sm">
                        {{ node.status }}
                      </c-badge>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Flechas de conexión (visuales) -->
              <div class="level-arrows" *ngIf="level < getLevels().length - 1">
                <div class="arrow-down">
                  <i class="cil-arrow-bottom"></i>
                </div>
              </div>
            </div>

            <!-- Mensaje si no hay datos -->
            <div *ngIf="!graph || graph.nodes.length === 0" class="text-center py-5">
              <i class="cil-inbox" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No hay datos en el grafo</p>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Explicación del Grafo -->
  <c-row class="mt-4">
    <c-col md="6">
      <c-card>
        <c-card-header>
          <i class="cil-info me-2"></i>
          <strong>¿Qué es el Grafo?</strong>
        </c-card-header>
        <c-card-body>
          <p>El <strong>grafo de credenciales</strong> representa la estructura de relaciones y permisos del sistema:</p>
          <ul>
            <li><strong>Nodos:</strong> Entidades del sistema (Admin, Contadores, Clientes, Credenciales)</li>
            <li><strong>Aristas:</strong> Relaciones entre entidades (gestiona, asignado a, posee, delegado a)</li>
            <li><strong>Niveles:</strong> Jerarquía de acceso (del Admin a las Credenciales)</li>
          </ul>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col md="6">
      <c-card>
        <c-card-header>
          <i class="cil-check-circle me-2"></i>
          <strong>Funciones del Grafo</strong>
        </c-card-header>
        <c-card-body>
          <ul class="list-unstyled">
            <li class="mb-2">
              <i class="cil-check text-success me-2"></i>
              <strong>Control de Acceso:</strong> Determina quién puede ver cada credencial
            </li>
            <li class="mb-2">
              <i class="cil-check text-success me-2"></i>
              <strong>Delegación:</strong> Permite acceso temporal a otros usuarios
            </li>
            <li class="mb-2">
              <i class="cil-check text-success me-2"></i>
              <strong>Auditoría:</strong> Rastrea todos los accesos a credenciales
            </li>
            <li class="mb-2">
              <i class="cil-check text-success me-2"></i>
              <strong>Navegación:</strong> Facilita encontrar relaciones entre entidades
            </li>
          </ul>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>
