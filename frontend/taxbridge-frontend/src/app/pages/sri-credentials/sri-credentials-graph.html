<c-container fluid>
  <!-- Header -->
  <c-row class="mb-4">
    <c-col>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="cil-graph me-2"></i>
            {{ viewTitle || 'Grafo de Credenciales SRI' }}
          </h2>
          <p class="text-muted mb-0">{{ viewDescription || 'Visualización jerárquica del sistema de acceso a credenciales' }}</p>
        </div>
        <div class="d-flex gap-2">
          <button cButton color="secondary" (click)="refreshGraph()">
            <i class="cil-reload me-1"></i> Actualizar
          </button>
          <button cButton color="primary" [routerLink]="['/sri-credentials']">
            <i class="cil-list me-1"></i> Ver Lista
          </button>
        </div>
      </div>
    </c-col>
  </c-row>

  <!-- Leyenda del Grafo -->
  <c-row class="mb-4">
    <c-col>
      <c-card>
        <c-card-body class="py-2">
          <div class="d-flex justify-content-center align-items-center flex-wrap gap-4">
            <div class="legend-item">
              <span class="node-indicator node-admin"></span>
              <span>Admin</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-contador"></span>
              <span>Contador</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-customer"></span>
              <span>Cliente</span>
            </div>
            <div class="legend-item">
              <span class="node-indicator node-credential"></span>
              <span>Credencial SRI</span>
            </div>
            <div class="legend-item">
              <i class="cil-arrow-bottom text-primary"></i>
              <span>Relación directa</span>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Estadísticas del Grafo -->
  <c-row class="mb-4">
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-primary">{{ stats.totalNodes }}</div>
          <small class="text-muted">Nodos</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-secondary">{{ stats.totalEdges }}</div>
          <small class="text-muted">Conexiones</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-info">{{ stats.contadores }}</div>
          <small class="text-muted">Contadores</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-success">{{ stats.clientes }}</div>
          <small class="text-muted">Clientes</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-warning">{{ stats.credenciales }}</div>
          <small class="text-muted">Credenciales</small>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="4" md="2">
      <c-card class="text-center bg-light">
        <c-card-body class="py-3">
          <div class="fs-4 fw-bold text-danger">{{ stats.delegaciones }}</div>
          <small class="text-muted">Delegaciones</small>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <c-spinner color="primary"></c-spinner>
    <p class="mt-3 text-muted">Cargando estructura del grafo...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-danger text-center">
    <i class="cil-warning me-2"></i>{{ error }}
  </div>

  <!-- Visualización del Grafo Jerárquico -->
  <c-row *ngIf="!loading && !error && graph">
    <c-col>
      <c-card>
        <c-card-header>
          <strong>Estructura Jerárquica de Credenciales SRI</strong>
          <span class="text-muted ms-2" *ngIf="viewType === 'full'">
            (Admin → Contadores → Clientes → Credenciales)
          </span>
          <span class="text-muted ms-2" *ngIf="viewType === 'contador'">
            (Tus Clientes → Credenciales)
          </span>
          <span class="text-muted ms-2" *ngIf="viewType === 'cliente'">
            (Tu Contador → Tus Credenciales)
          </span>
        </c-card-header>
        <c-card-body>
          <div class="hierarchy-container">
            
            <!-- Nodo Admin (Raíz) - Solo visible para admin -->
            <div class="hierarchy-level level-admin" *ngIf="viewType === 'full'">
              <div class="level-title">
                <c-badge color="dark" class="fs-5 px-3 py-2">Administración</c-badge>
              </div>
              <div class="admin-node">
                <div class="graph-node node-admin">
                  <div class="node-icon">
                    <i class="cil-shield-alt"></i>
                  </div>
                  <div class="node-content">
                    <div class="node-label">Administración TaxBridge</div>
                    <small class="text-muted">Nivel 0</small>
                  </div>
                </div>
              </div>
              <div class="level-connector">
                <i class="cil-arrow-bottom"></i>
              </div>
            </div>

            <!-- Contadores con sus Clientes y Credenciales -->
            <div class="hierarchy-level level-contadores">
              <div class="level-title">
                <c-badge color="info" class="fs-5 px-3 py-2">Contadores</c-badge>
              </div>

              <div class="contadores-grid">
                <!-- Grupo por Contador -->
                <div *ngFor="let contadorId of getHierarchyGroupKeys()" class="contador-group">
                  <c-card class="shadow-sm mb-0">
                    <c-card-header class="bg-info text-white py-2">
                      <div class="d-flex align-items-center justify-content-between">
                        <div>
                          <div class="d-flex align-items-center">
                            <i class="cil-calculator me-2"></i>
                            <strong>{{ hierarchyGroups[contadorId].contador.label }}</strong>
                          </div>
                          <small>{{ hierarchyGroups[contadorId].contador.email }}</small>
                        </div>
                        <c-badge color="light" class="text-info fs-6 px-2">
                          <i class="cil-people me-1"></i>
                          {{ hierarchyGroups[contadorId].totalHijos }}
                        </c-badge>
                      </div>
                    </c-card-header>
                    <c-card-body class="p-3">
                      
                      <!-- Clientes del Contador -->
                      <div *ngFor="let clienteGroup of hierarchyGroups[contadorId].clientes; let isLast = last" 
                           class="cliente-section">
                        
                        <!-- Flecha Contador → Cliente -->
                        <div class="arrow-container">
                          <div class="arrow-label">atiende a</div>
                          <i class="cil-arrow-bottom text-primary"></i>
                        </div>

                        <!-- Nodo Cliente -->
                        <div class="graph-node node-customer mb-2">
                          <div class="node-icon">
                            <i class="cil-user"></i>
                          </div>
                          <div class="node-content">
                            <div class="node-label">{{ clienteGroup.cliente.label }}</div>
                            <div class="node-details">
                              <small>{{ clienteGroup.cliente.customerNumber }}</small>
                            </div>
                          </div>
                        </div>

                        <!-- Credenciales del Cliente -->
                        <div class="credenciales-list" *ngIf="clienteGroup.credenciales.length > 0">
                          
                          <!-- Flecha Cliente → Credenciales -->
                          <div class="arrow-container-small">
                            <div class="arrow-label-small">posee</div>
                            <i class="cil-arrow-bottom text-warning"></i>
                          </div>

                          <div class="credenciales-grid">
                            <div *ngFor="let credencial of clienteGroup.credenciales" 
                                 class="graph-node node-credential node-credential-small">
                              <div class="node-icon-small">
                                <i class="cil-lock-locked"></i>
                              </div>
                              <div class="node-content-small">
                                <div class="node-label-small">{{ credencial.label }}</div>
                                <div class="node-details">
                                  <small class="font-monospace">{{ credencial.credentialId }}</small>
                                </div>
                                <div class="node-details">
                                  <small>{{ credencial.subtitle }}</small>
                                </div>
                                <c-badge 
                                  [color]="credencial.status === 'active' ? 'success' : 'secondary'" 
                                  size="sm">
                                  {{ credencial.status }}
                                </c-badge>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Separador entre clientes -->
                        <hr *ngIf="!isLast" class="my-3">
                      </div>

                      <!-- Mensaje si no hay clientes -->
                      <div *ngIf="hierarchyGroups[contadorId].clientes.length === 0" 
                           class="text-center text-muted py-3">
                        <i class="cil-inbox"></i>
                        <p class="mb-0 mt-2">Sin clientes asignados</p>
                      </div>

                    </c-card-body>
                  </c-card>
                </div>
              </div>

              <!-- Mensaje si no hay contadores -->
              <div *ngIf="getHierarchyGroupKeys().length === 0" class="text-center py-5">
                <i class="cil-inbox" style="font-size: 3rem; color: #ccc;"></i>
                <p class="text-muted mt-2">No hay contadores en el sistema</p>
              </div>
            </div>

          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Explicación del Grafo -->
  <c-row class="mt-4">
    <c-col md="6">
      <c-card>
        <c-card-header>
          <i class="cil-info me-2"></i>
          <strong>{{ viewType === 'full' ? 'Estructura del Grafo' : (viewType === 'contador' ? 'Tus Clientes' : 'Tus Credenciales') }}</strong>
        </c-card-header>
        <c-card-body>
          <p *ngIf="viewType === 'full'">El grafo muestra la jerarquía completa del sistema:</p>
          <p *ngIf="viewType === 'contador'">Esta vista muestra todos tus clientes asignados:</p>
          <p *ngIf="viewType === 'cliente'">Esta vista muestra tus credenciales SRI y tu contador:</p>
          
          <ul *ngIf="viewType === 'full'">
            <li><strong>Admin:</strong> Nodo raíz que gestiona todos los contadores</li>
            <li><strong>Contadores:</strong> Cada contador tiene clientes asignados</li>
            <li><strong>Clientes:</strong> Cada cliente posee una o más credenciales SRI</li>
            <li><strong>Credenciales:</strong> Accesos al portal del SRI por cliente</li>
          </ul>
          
          <ul *ngIf="viewType === 'contador'">
            <li><strong>Clientes:</strong> Todos los clientes que tienes asignados</li>
            <li><strong>Credenciales:</strong> Las credenciales SRI de cada cliente</li>
            <li>Puedes ver y gestionar las credenciales de tus clientes</li>
          </ul>
          
          <ul *ngIf="viewType === 'cliente'">
            <li><strong>Tu Contador:</strong> El contador que te atiende</li>
            <li><strong>Tus Credenciales:</strong> Todas tus credenciales del SRI</li>
            <li>Puedes consultar el estado de tus credenciales</li>
          </ul>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col md="6">
      <c-card>
        <c-card-header>
          <i class="cil-check-circle me-2"></i>
          <strong>Relaciones del Grafo</strong>
        </c-card-header>
        <c-card-body>
          <ul class="list-unstyled">
            <li class="mb-2" *ngIf="viewType === 'full'">
              <i class="cil-arrow-right text-success me-2"></i>
              <strong>Admin → Contador:</strong> Gestiona y supervisa
            </li>
            <li class="mb-2" *ngIf="viewType === 'full' || viewType === 'contador'">
              <i class="cil-arrow-right text-info me-2"></i>
              <strong>Contador → Cliente:</strong> Atiende y asesora
            </li>
            <li class="mb-2">
              <i class="cil-arrow-right text-warning me-2"></i>
              <strong>Cliente → Credencial:</strong> Posee y utiliza
            </li>
            <li class="mb-2">
              <i class="cil-info text-muted me-2"></i>
              <strong>Nota:</strong> Un cliente puede tener múltiples credenciales SRI
            </li>
          </ul>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>
