<c-container fluid>
  <!-- Header -->
  <c-row class="mb-4">
    <c-col>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="cil-lock-locked me-2"></i>
            Credenciales SRI
          </h2>
          <p class="text-muted mb-0">Gestión de credenciales del Servicio de Rentas Internas</p>
        </div>
        <div class="d-flex gap-2">
          <button cButton color="info" [routerLink]="['/sri-credentials/graph']" *ngIf="!isCliente">
            <i class="cil-graph me-1"></i> Ver Grafo
          </button>
          <button cButton color="primary" (click)="openCreateModal()">
            <i class="cil-plus me-1"></i> Nueva Credencial
          </button>
        </div>
      </div>
    </c-col>
  </c-row>

  <!-- KPIs -->
  <c-row class="mb-4">
    <c-col sm="6" lg="3">
      <c-card class="h-100 border-start border-primary border-start-4">
        <c-card-body>
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-body-secondary text-uppercase fw-semibold small">Total Credenciales</div>
              <div class="fs-4 fw-semibold">{{ kpis.total }}</div>
            </div>
            <div class="text-primary">
              <i class="cil-lock-locked" style="font-size: 2rem;"></i>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="6" lg="3">
      <c-card class="h-100 border-start border-success border-start-4">
        <c-card-body>
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-body-secondary text-uppercase fw-semibold small">Activas</div>
              <div class="fs-4 fw-semibold text-success">{{ kpis.active }}</div>
            </div>
            <div class="text-success">
              <i class="cil-check-circle" style="font-size: 2rem;"></i>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="6" lg="3">
      <c-card class="h-100 border-start border-secondary border-start-4">
        <c-card-body>
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-body-secondary text-uppercase fw-semibold small">Inactivas</div>
              <div class="fs-4 fw-semibold text-secondary">{{ kpis.inactive }}</div>
            </div>
            <div class="text-secondary">
              <i class="cil-x-circle" style="font-size: 2rem;"></i>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col sm="6" lg="3">
      <c-card class="h-100 border-start border-warning border-start-4">
        <c-card-body>
          <div class="d-flex justify-content-between">
            <div>
              <div class="text-body-secondary text-uppercase fw-semibold small">Por Expirar</div>
              <div class="fs-4 fw-semibold text-warning">{{ kpis.expiring }}</div>
            </div>
            <div class="text-warning">
              <i class="cil-warning" style="font-size: 2rem;"></i>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Búsqueda -->
  <c-row class="mb-3">
    <c-col lg="6">
      <div class="input-group">
        <span class="input-group-text"><i class="cil-search"></i></span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por ID, cliente, RUC o contador..."
          [(ngModel)]="searchText"
          (input)="applyFilter()">
      </div>
    </c-col>
  </c-row>

  <!-- Tabla de Credenciales -->
  <c-row>
    <c-col>
      <c-card>
        <c-card-header>
          <strong>Listado de Credenciales</strong>
        </c-card-header>
        <c-card-body>
          <!-- Loading -->
          <div *ngIf="loading" class="text-center py-5">
            <c-spinner color="primary"></c-spinner>
            <p class="mt-2 text-muted">Cargando credenciales...</p>
          </div>

          <!-- Error -->
          <div *ngIf="error" class="alert alert-danger">
            <i class="cil-warning me-2"></i>{{ error }}
          </div>

          <!-- No data -->
          <div *ngIf="!loading && !error && filteredCredentials.length === 0" class="text-center py-5">
            <i class="cil-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-2">No se encontraron credenciales</p>
            <button cButton color="primary" size="sm" (click)="openCreateModal()">
              Crear primera credencial
            </button>
          </div>

          <!-- Tabla -->
          <div *ngIf="!loading && filteredCredentials.length > 0" class="table-responsive">
            <table cTable hover>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>RUC</th>
                  <th>Tipo</th>
                  <th *ngIf="!isCliente">Contador Asignado</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cred of filteredCredentials">
                  <td>
                    <code>{{ cred.credentialId }}</code>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ cred.customerName }}</div>
                    <small class="text-muted">{{ cred.customerNumber }}</small>
                  </td>
                  <td>
                    <span class="font-monospace">{{ cred.ruc }}</span>
                  </td>
                  <td>
                    {{ getTipoContribuyenteLabel(cred.tipoContribuyente) }}
                  </td>
                  <td *ngIf="!isCliente">
                    <span *ngIf="cred.assignedContadorName">{{ cred.assignedContadorName }}</span>
                    <span *ngIf="!cred.assignedContadorName" class="text-muted">Sin asignar</span>
                  </td>
                  <td>
                    <c-badge [color]="getStatusBadge(cred.status)">
                      {{ getStatusLabel(cred.status) }}
                    </c-badge>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button 
                        cButton 
                        color="info" 
                        size="sm" 
                        (click)="openDetailModal(cred)"
                        title="Ver detalle"
                        class="text-white">
                        <i class="cil-info"></i>
                      </button>
                      <button 
                        cButton 
                        color="warning" 
                        size="sm" 
                        (click)="openEditModal(cred)"
                        title="Editar"
                        class="text-white">
                        <i class="cil-pencil"></i>
                      </button>
                      <button 
                        *ngIf="!isCliente"
                        cButton 
                        color="secondary" 
                        size="sm" 
                        [routerLink]="['/sri-credentials', cred._id, 'graph']"
                        title="Ver grafo de acceso">
                        <i class="cil-graph"></i>
                      </button>
                      <button 
                        *ngIf="isAdmin"
                        cButton 
                        color="danger" 
                        size="sm" 
                        (click)="deleteCredential(cred._id!, cred.credentialId!)"
                        [disabled]="deleting[cred._id!]"
                        title="Eliminar">
                        <c-spinner *ngIf="deleting[cred._id!]" size="sm"></c-spinner>
                        <i *ngIf="!deleting[cred._id!]" class="cil-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>

<!-- Modal de Creación -->
<c-modal 
  [visible]="showCreateModal" 
  (visibleChange)="onCreateModalVisibleChange($event)" 
  alignment="center" 
  size="lg"
  [backdrop]="true">
  <c-modal-header>
    <h5 class="modal-title">
      <i class="cil-plus me-2"></i>
      Nueva Credencial SRI
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeCreateModal()"></button>
  </c-modal-header>
  <c-modal-body>
    <!-- Mensaje de error -->
    <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
      <i class="cil-warning me-2"></i>
      {{ errorMessage }}
    </div>

    <form cForm>
      <c-row class="mb-3">
        <c-col md="6">
          <label cLabel for="customerNumber">Número de Cliente *</label>
          <input 
            cFormControl 
            type="text" 
            id="customerNumber" 
            [(ngModel)]="newCredential.customerNumber" 
            name="customerNumber"
            placeholder="TB-000001"
            readonly
            disabled
            class="bg-light"
            required>
          <small class="text-muted">Este es tu número de cliente</small>
        </c-col>
        <c-col md="6">
          <label cLabel for="ruc">RUC *</label>
          <input 
            cFormControl 
            type="text" 
            id="ruc" 
            [(ngModel)]="newCredential.ruc" 
            name="ruc"
            placeholder="1234567890001"
            maxlength="13"
            required>
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col md="6">
          <label cLabel for="sriUsername">Usuario SRI *</label>
          <input 
            cFormControl 
            type="text" 
            id="sriUsername" 
            [(ngModel)]="newCredential.sriUsername" 
            name="sriUsername"
            required>
        </c-col>
        <c-col md="6">
          <label cLabel for="sriPassword">Contraseña SRI *</label>
          <input 
            cFormControl 
            type="password" 
            id="sriPassword" 
            [(ngModel)]="newCredential.sriPassword" 
            name="sriPassword"
            required>
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col md="6">
          <label cLabel for="tipoContribuyente">Tipo de Contribuyente *</label>
          <select 
            cFormControl 
            id="tipoContribuyente" 
            [(ngModel)]="newCredential.tipoContribuyente" 
            name="tipoContribuyente">
            <option value="persona_natural">Persona Natural</option>
            <option value="sociedad">Sociedad</option>
            <option value="rise">RISE</option>
          </select>
        </c-col>
        <c-col md="6">
          <label cLabel for="razonSocial">Razón Social</label>
          <input 
            cFormControl 
            type="text" 
            id="razonSocial" 
            [(ngModel)]="newCredential.razonSocial" 
            name="razonSocial">
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col>
          <label cLabel for="notes">Notas</label>
          <textarea 
            cFormControl 
            id="notes" 
            [(ngModel)]="newCredential.notes" 
            name="notes"
            rows="3"></textarea>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeCreateModal()">Cancelar</button>
    <button 
      cButton 
      color="primary" 
      (click)="createCredential()"
      [disabled]="creating || !newCredential.customerNumber || !newCredential.sriUsername || !newCredential.sriPassword || !newCredential.ruc">
      <c-spinner *ngIf="creating" size="sm" class="me-2"></c-spinner>
      {{ creating ? 'Creando...' : 'Crear Credencial' }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- Modal de Detalle -->
<c-modal 
  [visible]="showDetailModal && selectedCredential !== null" 
  (visibleChange)="onDetailModalVisibleChange($event)" 
  alignment="center" 
  size="lg"
  [backdrop]="true">
  <c-modal-header>
    <h5 class="modal-title">
      <i class="cil-info me-2"></i>
      Detalle de Credencial SRI
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeDetailModal()"></button>
  </c-modal-header>
  <c-modal-body *ngIf="selectedCredential">
    <c-row class="mb-3">
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">ID de Credencial</label>
          <div class="fw-semibold"><code>{{ selectedCredential.credentialId }}</code></div>
        </div>
      </c-col>
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Estado</label>
          <div>
            <c-badge [color]="getStatusBadge(selectedCredential.status)">
              {{ getStatusLabel(selectedCredential.status) }}
            </c-badge>
          </div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3">
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Cliente</label>
          <div class="fw-semibold">{{ selectedCredential.customerName }}</div>
          <small class="text-muted">{{ selectedCredential.customerNumber }}</small>
        </div>
      </c-col>
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">RUC</label>
          <div class="fw-semibold font-monospace">{{ selectedCredential.ruc }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3">
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Usuario SRI</label>
          <div class="fw-semibold">{{ selectedCredential.sriUsername || 'No especificado' }}</div>
        </div>
      </c-col>
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Tipo de Contribuyente</label>
          <div class="fw-semibold">{{ getTipoContribuyenteLabel(selectedCredential.tipoContribuyente) }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3" *ngIf="selectedCredential.razonSocial">
      <c-col>
        <div class="detail-item">
          <label class="text-muted small">Razón Social</label>
          <div class="fw-semibold">{{ selectedCredential.razonSocial }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3" *ngIf="selectedCredential.assignedContadorName">
      <c-col>
        <div class="detail-item">
          <label class="text-muted small">Contador Asignado</label>
          <div class="fw-semibold">{{ selectedCredential.assignedContadorName }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3" *ngIf="selectedCredential.notes">
      <c-col>
        <div class="detail-item">
          <label class="text-muted small">Notas</label>
          <div>{{ selectedCredential.notes }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row class="mb-3" *ngIf="selectedCredential.expiresAt">
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Fecha de Expiración</label>
          <div class="fw-semibold">{{ selectedCredential.expiresAt | date:'dd/MM/yyyy' }}</div>
        </div>
      </c-col>
    </c-row>

    <c-row *ngIf="selectedCredential.createdAt">
      <c-col md="6">
        <div class="detail-item">
          <label class="text-muted small">Fecha de Creación</label>
          <div>{{ selectedCredential.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
        </div>
      </c-col>
      <c-col md="6" *ngIf="selectedCredential.updatedAt">
        <div class="detail-item">
          <label class="text-muted small">Última Actualización</label>
          <div>{{ selectedCredential.updatedAt | date:'dd/MM/yyyy HH:mm' }}</div>
        </div>
      </c-col>
    </c-row>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeDetailModal()">Cerrar</button>
    <button 
      cButton 
      color="primary" 
      *ngIf="selectedCredential"
      (click)="closeDetailModal(); openEditModal(selectedCredential)">
      <i class="cil-pencil me-1"></i> Editar
    </button>
  </c-modal-footer>
</c-modal>

<!-- Modal de Edición -->
<c-modal 
  [visible]="showEditModal && editCredential !== null" 
  (visibleChange)="onEditModalVisibleChange($event)" 
  alignment="center" 
  size="lg"
  [backdrop]="true">
  <c-modal-header>
    <h5 class="modal-title">
      <i class="cil-pencil me-2"></i>
      Editar Credencial SRI
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeEditModal()"></button>
  </c-modal-header>
  <c-modal-body *ngIf="editCredential">
    <!-- Mensaje de error -->
    <div *ngIf="editErrorMessage" class="alert alert-danger" role="alert">
      <i class="cil-warning me-2"></i>
      {{ editErrorMessage }}
    </div>

    <form cForm>
      <c-row class="mb-3">
        <c-col md="6">
          <label cLabel for="editRuc">RUC *</label>
          <input 
            cFormControl 
            type="text" 
            id="editRuc" 
            [(ngModel)]="editCredential.ruc" 
            name="ruc"
            maxlength="13"
            readonly
            disabled
            class="bg-light"
            required>
          <small class="text-muted">El RUC no se puede modificar</small>
        </c-col>
        <c-col md="6">
          <label cLabel for="editSriUsername">Usuario SRI *</label>
          <input 
            cFormControl 
            type="text" 
            id="editSriUsername" 
            [(ngModel)]="editCredential.sriUsername" 
            name="sriUsername"
            required>
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col md="6">
          <label cLabel for="editTipoContribuyente">Tipo de Contribuyente *</label>
          <select 
            cFormControl 
            id="editTipoContribuyente" 
            [(ngModel)]="editCredential.tipoContribuyente" 
            name="tipoContribuyente">
            <option value="persona_natural">Persona Natural</option>
            <option value="sociedad">Sociedad</option>
            <option value="rise">RISE</option>
          </select>
        </c-col>
        <c-col md="6">
          <label cLabel for="editStatus">Estado *</label>
          <select 
            cFormControl 
            id="editStatus" 
            [(ngModel)]="editCredential.status" 
            name="status">
            <option value="active">Activo</option>
            <option value="inactive">Inactivo</option>
            <option value="expired">Expirado</option>
            <option value="revoked">Revocado</option>
          </select>
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col>
          <label cLabel for="editRazonSocial">Razón Social</label>
          <input 
            cFormControl 
            type="text" 
            id="editRazonSocial" 
            [(ngModel)]="editCredential.razonSocial" 
            name="razonSocial">
        </c-col>
      </c-row>

      <c-row class="mb-3">
        <c-col>
          <label cLabel for="editNotes">Notas</label>
          <textarea 
            cFormControl 
            id="editNotes" 
            [(ngModel)]="editCredential.notes" 
            name="notes"
            rows="3"></textarea>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeEditModal()">Cancelar</button>
    <button 
      cButton 
      color="primary" 
      (click)="updateCredential()"
      [disabled]="updating || !editCredential || !editCredential.sriUsername || !editCredential.ruc">
      <c-spinner *ngIf="updating" size="sm" class="me-2"></c-spinner>
      {{ updating ? 'Guardando...' : 'Guardar Cambios' }}
    </button>
  </c-modal-footer>
</c-modal>
